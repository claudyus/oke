#!/bin/bash
# Copyright (C) 2010 - Claudio Mignanti
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

V=0.1

echo oke - Openwrt Kernel Extractor
echo ------------------------------
echo Version $V

#default value
branch=trunk
rev=HEAD
GDB="2> /dev/null"

pwd=`pwd`

_apply() {
	cd $pwd
	#files
	if [ -d $1/files-$kernel_patch ]; then
		cp -r $1/files-$kernel_patch/* \
			kernels/linux-$kernel/
	else
		cp -r $1/files/* \
			kernels/linux-$kernel/
	fi
	#patches
	if [ -d $1/patches-$kernel_patch ]; then
		cd kernels/linux-$kernel
		for pt in `ls $1/patches-$kernel_patch`; do
			echo $pt
			patch -p1 < $1/patches-$kernel_patch/$pt  $GDB
		done
	else
		for pt in `ls $1/patches`; do
			echo $pt
			patch -p1 < $1/patches/$pt $GDB
		done
	fi
}


#parse command line
while [ $# -gt 0 ]; do
  case $1  in
	-a)
	  arch=$2
	  shift 2
	;;
	-r)
	  rev=$2
	  shift 2
	;;
	-b)
	  branch=$2
	  shift 2
	;;
	-g)
	  generic=0
	  shift 1
	;;
	-l)
	  list=1
	  shift 1
	;;
	-R)
	  recovery=1
	  shift 1
	;;
	*)
	  cat README
	  exit 0
	;;
  esac
done

if [ ! -d ./svn/$branch ]; then
	echo Checkuot svn ...
	mkdir -p svn
	case $branch in
		trunk)
		repo=svn://svn.openwrt.org/openwrt/trunk/target
		;;
		backfire)
		repo=svn://svn.openwrt.org/openwrt/branches/backfire/target
		;;
		kamikaze)
		repo=svn://svn.openwrt.org/openwrt/branches/8.09/target
		;;
		*)
		echo Unsupported $branch 
		exit 0
		;;
	esac
	svn co $repo ./svn/$branch -r $rev
else
	echo Updating svn ... 
	svn up ./svn/$branch -r $rev
fi

if [ $list ]; then
	for a in `ls ./svn/$branch/linux`; do
		if [ $a != "generic" ]; then
			echo $a
		fi
	done
	exit 0
fi

if [ $recovery ]; then
	rm -fr svn/
	exit 0
fi

#parse kernel version
kernel=`grep -o 'LINUX_VERSION:=[0-9.]*' ./svn/$branch/linux/$arch/Makefile | grep -o '[0-9.]*' $kernel`
kernel_patch=`echo $kernel | grep -o '^[0-9]*.[0-9]*.[0-9]*' -`
echo $kernel_patch

mkdir -p kernels
if [ ! -f kernels/linux-$kernel.ori.tar.bz2 ]; then
	echo Downloading kernel $kernel...
	wget -c ftp://ftp.kernel.org/pub/linux/kernel/v2.6/linux-$kernel.tar.bz2 -O kernels/linux-$kernel.tar.bz2  $GDB
fi

#prepare patched dir
echo Preparing kernel...
rm -fr kernels/linux-$kernel kernels/linux-$kernel.ori/
tar xvjf kernels/linux-$kernel.tar.bz2 -C kernels/
mv  kernels/linux-$kernel/ kernels/linux-$kernel.ori

echo Preparing final dir...
cp -r kernels/linux-$kernel.ori kernels/linux-$kernel

#apply generic
if [ ! $generic ]; then
	echo Applying generic patches...
	#files
	_apply $pwd/svn/$branch/linux/generic 

else
	echo WARNING: Skipping generic patches. See README
fi

#apply arch specific 
echo Applying arch patches...
#files
_apply $pwd/svn/$branch/linux/$arch

#diff and tar
echo Cleanup pre-tar...
cd $pwd/kernels/linux-$kernel
find . -name '.svn' -exec rm -fr \{\} \;
cd ..

echo Genereting unified patch...
echo unified patch from oke v$V for $arch platform generated: `date` \
	> $pwd/patch_"$kernel"_$arch.patch
diff -Naur $pwd/kernels/linux-$kernel.ori $pwd/kernels/linux-$kernel \
	>> $pwd/patch_"$kernel"_$arch.patch 

echo Re-tar...
tar cjvf linux-$kernel-$arch.tar.bz2 linux-$kernel/* 
mv linux-$kernel-$arch.tar.bz2 ..

echo Success!
echo linux-$kernel-$arch.tar.bz2 is now in oke dir.
